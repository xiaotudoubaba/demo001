# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  run-agent:
    runs-on: windows-latest
    timeout-minutes: 15

    steps:
      - name: Prepare workspace
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path "$env:RUNNER_TEMP\agent" | Out-Null
          Write-Host "Temp dir: $env:RUNNER_TEMP\agent"

      # ===== Option B (external URL) =====
      # Safer pattern: require SHA256 to be set correctly, otherwise fail closed.
      - name: Download agent.zip (external URL)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $url = "https://download.happygogo.site/agent.zip"
          $zip = Join-Path $env:RUNNER_TEMP "agent\agent.zip"

          Invoke-WebRequest -Uri $url -OutFile $zip -MaximumRedirection 5
          if (!(Test-Path $zip)) { throw "Download failed: $zip not found" }

          Write-Host "Downloaded to: $zip"
          Get-Item $zip | Format-List *

      - name: Verify SHA256 (MUST set expected hash)
        shell: pwsh
        env:
          # TODO: Replace with the real SHA256 of agent.zip before this workflow can run successfully.
          # Example: ABCDEF... (64 hex chars)
          AGENT_ZIP_SHA256: "1C74F408A9E791C4DB4C0DC13D96810A89485E8B4E9E869B474E896DCFA7C62C"
        run: |
          $ErrorActionPreference = "Stop"

          $zip = Join-Path $env:RUNNER_TEMP "agent\agent.zip"
          $expected = "$env:AGENT_ZIP_SHA256".Trim().ToLower()

          if ($expected -eq "" -or $expected -like "replace_with_real_sha256*") {
            throw "AGENT_ZIP_SHA256 is not set. Refusing to run unverified binary."
          }

          $actual = (Get-FileHash -Algorithm SHA256 -Path $zip).Hash.ToLower()
          Write-Host "Expected: $expected"
          Write-Host "Actual:   $actual"

          if ($actual -ne $expected) {
            throw "SHA256 mismatch. Refusing to execute."
          }

      - name: Extract agent.zip
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $zip = Join-Path $env:RUNNER_TEMP "agent\agent.zip"
          $dst = Join-Path $env:RUNNER_TEMP "agent\unzipped"

          Expand-Archive -Path $zip -DestinationPath $dst -Force
          Write-Host "Extracted to: $dst"
          Get-ChildItem -Recurse -File $dst | Select-Object FullName, Length

      - name: Run main.exe
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $workdir = Join-Path $env:RUNNER_TEMP "agent\unzipped"
          $exe = Join-Path $workdir "main.exe"

          if (!(Test-Path $exe)) {
            throw "main.exe not found at: $exe"
          }

          Push-Location $workdir
          try {
            # Run and propagate exit code
            & $exe
            if ($LASTEXITCODE -ne 0) {
              throw "main.exe exited with code $LASTEXITCODE"
            }
          } finally {
            Pop-Location
          }
